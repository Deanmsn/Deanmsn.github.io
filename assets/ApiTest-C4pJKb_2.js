import{m as E,g as P}from"./market-CW_V7YUN.js";import{d as D,g as _,p as w,c as d,a as t,j as y,t as l,m as q,e as g,o as v,_ as A,q as x,F as $,k as O,f as I}from"./index-B94m1PT7.js";const F={class:"api-status"},N={class:"status-text"},j={key:0,class:"last-request"},L={key:1,class:"stats"},M={class:"stat-item"},V={class:"stat-value"},B={class:"stat-item"},H={class:"stat-value success"},K={class:"stat-item"},z={class:"stat-value error"},U={class:"stat-item"},W={class:"stat-value"},G=D({__name:"ApiStatus",setup(m,{expose:u}){const n=_("idle"),o=_(null),c=_([]),i=w(()=>{switch(n.value){case"idle":return"空闲";case"loading":return"请求中";case"success":return"成功";case"error":return"错误";default:return"未知"}}),r=w(()=>{const p=c.value.length,e=c.value.filter(a=>a.success).length,s=p-e;return{total:p,success:e,failed:s}}),h=w(()=>r.value.total===0?0:Math.round(r.value.success/r.value.total*100)),k=p=>new Date(p).toLocaleTimeString();return u({recordRequest:(p,e)=>{const s={time:Date.now(),duration:p,success:e};c.value.push(s),o.value=s,c.value.length>10&&(c.value=c.value.slice(-10))},setStatus:p=>{n.value=p}}),(p,e)=>(v(),d("div",F,[t("div",{class:q(["status-indicator",n.value])},[e[0]||(e[0]=t("div",{class:"indicator-dot"},null,-1)),t("span",N,l(i.value),1)],2),o.value?(v(),d("div",j,[t("p",null,[e[1]||(e[1]=t("strong",null,"最后请求:",-1)),g(" "+l(k(o.value.time)),1)]),t("p",null,[e[2]||(e[2]=t("strong",null,"响应时间:",-1)),g(" "+l(o.value.duration)+"ms",1)]),t("p",null,[e[3]||(e[3]=t("strong",null,"状态:",-1)),g(" "+l(o.value.success?"成功":"失败"),1)])])):y("",!0),r.value?(v(),d("div",L,[t("div",M,[e[4]||(e[4]=t("span",{class:"stat-label"},"总请求",-1)),t("span",V,l(r.value.total),1)]),t("div",B,[e[5]||(e[5]=t("span",{class:"stat-label"},"成功",-1)),t("span",H,l(r.value.success),1)]),t("div",K,[e[6]||(e[6]=t("span",{class:"stat-label"},"失败",-1)),t("span",z,l(r.value.failed),1)]),t("div",U,[e[7]||(e[7]=t("span",{class:"stat-label"},"成功率",-1)),t("span",W,l(h.value)+"%",1)])])):y("",!0)]))}}),J=A(G,[["__scopeId","data-v-e3851fb7"]]);function S(m){return m.message?.includes("CORS")||m.message?.includes("cors")||m.message?.includes("Access-Control")||m.code==="ERR_NETWORK"||m.name==="NetworkError"}function T(m){return S(m)?`跨域请求被阻止。请检查：
1. 服务器是否允许跨域请求
2. 是否使用了正确的代理配置
3. 网络连接是否正常`:m.message||"未知错误"}async function Q(m,u={}){const n=[()=>fetch(m,{...u,mode:"cors"}),()=>fetch(`https://www.moyu-idle.com${m}`,{...u,mode:"cors",headers:{...u.headers,Origin:window.location.origin}}),()=>fetch(m,{...u,mode:"no-cors"})];for(let o=0;o<n.length;o++)try{const c=await n[o]();if(c.ok)return c}catch(c){if(console.log(`方法${o+1}失败:`,c),o===n.length-1)throw c}throw new Error("所有请求方法都失败了")}const X={class:"api-test"},Y={class:"test-section"},Z={class:"test-controls"},ss=["disabled"],ts=["disabled"],es=["disabled"],as={class:"test-results"},os={key:0,class:"loading"},ls={key:1,class:"error"},ns={key:2,class:"success"},rs={class:"result-info"},us={class:"sample-data"},is={class:"item-details"},cs={class:"sell-info"},ds={key:0},vs={key:1},ms={class:"buy-info"},ps={key:0},fs={key:1},_s={class:"test-section"},gs={class:"log-container"},ys={class:"log-time"},ws={class:"log-message"},hs=D({__name:"ApiTest",setup(m){const u=_(!1),n=_(""),o=_(null),c=_([]),i=_(),r=(e,s="info")=>{c.value.unshift({time:new Date().toLocaleTimeString(),message:e,type:s})},h=e=>e?new Date(e).toLocaleString():"未知",k=async()=>{u.value=!0,n.value="",o.value=null,i.value?.setStatus("loading"),r("开始测试市场价格API...","info");const e=Date.now();try{const s=await E.getMarketPrice();o.value=s;const a=Date.now()-e;i.value?.recordRequest(a,!0),i.value?.setStatus("success"),r("API请求成功","success")}catch(s){n.value=s instanceof Error?s.message:"未知错误",S(s)&&(n.value=T(s),r("检测到CORS错误，建议使用代理或联系服务器管理员","error"));const a=Date.now()-e;i.value?.recordRequest(a,!1),i.value?.setStatus("error"),r(`API请求失败: ${n.value}`,"error")}finally{u.value=!1}},R=async()=>{u.value=!0,n.value="",o.value=null,i.value?.setStatus("loading"),r("开始测试直接Fetch请求...","info");const e=Date.now();try{const s=await fetch("https://www.moyu-idle.com/api/game/market/price");if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);const a=await s.json();o.value=a;const f=Date.now()-e;i.value?.recordRequest(f,!0),i.value?.setStatus("success"),r("Fetch请求成功","success")}catch(s){n.value=s instanceof Error?s.message:"未知错误",S(s)&&(n.value=T(s),r("检测到CORS错误，建议使用代理或联系服务器管理员","error"));const a=Date.now()-e;i.value?.recordRequest(a,!1),i.value?.setStatus("error"),r(`Fetch请求失败: ${n.value}`,"error")}finally{u.value=!1}},b=async()=>{u.value=!0,n.value="",o.value=null,i.value?.setStatus("loading"),r("开始测试CORS修复方法...","info");const e=Date.now();try{const s=await Q("/api/game/market/price");if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);const a=await s.json();o.value=a;const f=Date.now()-e;i.value?.recordRequest(f,!0),i.value?.setStatus("success"),r("CORS修复请求成功","success")}catch(s){n.value=s instanceof Error?s.message:"未知错误";const a=Date.now()-e;i.value?.recordRequest(a,!1),i.value?.setStatus("error"),r(`CORS修复请求失败: ${n.value}`,"error")}finally{u.value=!1}},p=w(()=>{if(!o.value?.data?.items)return{};const e=o.value.data.items,a=Object.keys(e).slice(0,5),f={};return a.forEach(C=>{f[C]=e[C]}),f});return(e,s)=>(v(),d("div",X,[s[12]||(s[12]=t("h1",null,"API 测试页面",-1)),x(J,{ref_key:"apiStatusRef",ref:i},null,512),t("div",Y,[s[10]||(s[10]=t("h2",null,"市场价格API测试",-1)),t("div",Z,[t("button",{onClick:k,disabled:u.value},l(u.value?"请求中...":"测试市场价格API"),9,ss),t("button",{onClick:R,disabled:u.value}," 测试直接Fetch ",8,ts),t("button",{onClick:b,disabled:u.value}," 测试CORS修复 ",8,es)]),t("div",as,[u.value?(v(),d("div",os,s[0]||(s[0]=[t("div",{class:"spinner"},null,-1),t("p",null,"请求中...",-1)]))):y("",!0),n.value?(v(),d("div",ls,[s[1]||(s[1]=t("h3",null,"错误信息",-1)),t("pre",null,l(n.value),1)])):y("",!0),o.value?(v(),d("div",ns,[s[9]||(s[9]=t("h3",null,"请求成功",-1)),t("div",rs,[t("p",null,[s[2]||(s[2]=t("strong",null,"状态码:",-1)),g(" "+l(o.value.code),1)]),t("p",null,[s[3]||(s[3]=t("strong",null,"消息:",-1)),g(" "+l(o.value.msg),1)]),t("p",null,[s[4]||(s[4]=t("strong",null,"商品数量:",-1)),g(" "+l(Object.keys(o.value.data?.items||{}).length),1)]),t("p",null,[s[5]||(s[5]=t("strong",null,"最后更新时间:",-1)),g(" "+l(h(o.value.data?.lastUpdateTime)),1)])]),t("div",us,[s[8]||(s[8]=t("h4",null,"示例数据 (前5个商品)",-1)),(v(!0),d($,null,O(p.value,(a,f)=>(v(),d("div",{key:f,class:"item"},[t("h5",null,l(I(P)(f)),1),t("div",is,[t("div",cs,[s[6]||(s[6]=t("strong",null,"出售信息:",-1)),a.sellOrders?(v(),d("span",ds," 最低价: "+l(a.sellOrders.minPrice)+", 数量: "+l(a.sellOrders.minPriceCount)+", 订单数: "+l(a.sellOrders.orderCount),1)):(v(),d("span",vs,"无出售订单"))]),t("div",ms,[s[7]||(s[7]=t("strong",null,"求购信息:",-1)),a.buyOrders?(v(),d("span",ps," 最高价: "+l(a.buyOrders.maxPrice)+", 数量: "+l(a.buyOrders.maxPriceCount)+", 订单数: "+l(a.buyOrders.orderCount),1)):(v(),d("span",fs,"无求购订单"))])])]))),128))])])):y("",!0)])]),t("div",_s,[s[11]||(s[11]=t("h2",null,"请求日志",-1)),t("div",gs,[(v(!0),d($,null,O(c.value,(a,f)=>(v(),d("div",{key:f,class:q(["log-item",a.type])},[t("span",ys,l(a.time),1),t("span",ws,l(a.message),1)],2))),128))])])]))}}),Rs=A(hs,[["__scopeId","data-v-825d4b53"]]);export{Rs as default};
